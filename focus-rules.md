# Focus 后端项目编码规范和架构指南

## 项目架构

### 目录结构
```
src/
  ├── config/         # 配置相关
  ├── controllers/    # 控制器，处理路由请求
  ├── middlewares/    # 中间件
  ├── models/         # 数据模型
  ├── routes/         # API 路由定义
  │   └── v1/         # API v1 版本
  ├── scripts/        # 脚本工具
  ├── services/       # 服务层逻辑
  ├── utils/          # 工具函数
  ├── app.js          # 应用初始化
  └── index.js        # 应用入口
prisma/
  ├── schema.prisma   # 数据库模型定义
  └── migrations/     # 数据库迁移文件
```

### 架构模式
项目采用分层架构模式（Layered Architecture），具体包括：

1. **路由层(Routes)**: 定义 API 端点和请求方法
2. **控制器层(Controllers)**: 处理请求并协调服务层
3. **服务层(Services)**: 包含业务逻辑
4. **数据访问层(Models/Prisma)**: 处理数据库交互

## 编码规范

### 通用规范

1. **使用 ES Module 格式**
   - 使用 `import/export` 而非 CommonJS 的 `require/module.exports`

2. **异步处理**
   - 优先使用 async/await 而非回调或 Promise 链
   - 使用 try/catch 进行错误处理

3. **变量命名**
   - 使用驼峰命名法(camelCase)命名变量和函数
   - 使用有意义的名称，避免缩写

4. **代码注释**
   - 关键函数和复杂逻辑需要添加注释
   - 使用 JSDoc 格式为函数添加参数和返回值说明

### API 规范

1. **路由定义**
   - 路由路径使用小写单词，多个单词用连字符(-)分隔
   - 遵循 RESTful 设计原则
   - 使用版本前缀，如 `/api/v1/resource`

2. **响应格式**
   - 统一响应格式：`{ code: number, message: string, data?: any }`
   - 成功请求：`code: 0`
   - 错误请求：`code: 非0值`，包含具体错误信息

3. **错误处理**
   - 使用全局错误处理中间件捕获异常
   - 为不同类型错误定义明确的状态码和错误消息

### 数据库规范

1. **使用 Prisma ORM**
   - 所有数据库操作通过 Prisma 完成
   - 复杂查询放在对应的服务层中

2. **表设计**
   - 表名使用复数形式，小写
   - 字段名使用 camelCase
   - 主键统一使用 UUID 类型

3. **关系设计**
   - 明确定义模型间关系
   - 合理使用级联删除

### 安全规范

1. **身份验证**
   - 使用 JWT 进行用户认证
   - 敏感路由强制使用身份验证中间件

2. **数据验证**
   - 所有用户输入必须经过验证
   - 使用 express-validator 进行请求验证

3. **密码处理**
   - 使用 bcrypt 进行密码哈希
   - 不在日志中记录敏感信息

### 性能规范

1. **缓存策略**
   - 合理使用 Redis 缓存频繁访问的数据
   - 为高频 API 设置合理的缓存时间

2. **错误日志**
   - 使用结构化日志格式
   - 记录所有关键操作和错误

## 开发流程

1. **版本控制**
   - 使用 Git 进行版本控制
   - 遵循 Git Flow 工作流
   - 使用有意义的提交信息：`类型(范围): 描述`

2. **环境配置**
   - 使用 .env 文件管理环境变量
   - 区分开发、测试和生产环境配置

3. **测试**
   - 编写单元测试和集成测试
   - 在提交前运行测试

4. **代码审查**
   - 所有代码变更需经过代码审查
   - 使用 ESLint 进行代码质量检查

## 服务架构

项目集成了多种语音处理和翻译服务：

1. **语音识别服务**
   - 支持讯飞语音识别
   - 支持阿里云语音识别
   - 支持实时语音转文字

2. **文件处理服务**
   - 支持音频文件上传和处理
   - 支持多种音频格式转换

3. **翻译服务**
   - 支持多语言翻译
   - 支持语音和文本转换

## 部署指南

1. **环境准备**
   - Node.js >= 16.x
   - MySQL 数据库
   - Redis 缓存服务

2. **应用部署**
   - 使用 PM2 进行进程管理
   - 配置健康检查和自动重启

3. **数据库迁移**
   - 使用 Prisma 迁移命令更新数据库架构
   - 运行 `npx prisma migrate deploy` 